# 分布式定时任务系统架构设计

## 系统概述

这是一个基于Go语言开发的分布式定时任务系统，采用微服务架构，支持高并发、高可用的任务调度和执行。系统由API Server和Worker两个核心组件组成，通过WebSocket进行实时通信。

## 系统架构

```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│   API Server    │◄──────────────►│     Worker      │
│                 │                 │                 │
│ • 任务管理      │                 │ • 任务执行      │
│ • 调度服务      │                 │ • Runner管理    │
│ • 状态跟踪      │                 │ • 结果上报      │
│ • WebSocket服务 │                 │ • 心跳保活      │
└─────────────────┘                 └─────────────────┘
         │                                   │
         │                                   │
    ┌─────────┐                         ┌─────────┐
    │  Redis  │                         │  MySQL  │
    │         │                         │         │
    │ • 分布式锁 │                       │ • 数据持久化 │
    │ • 缓存    │                       │ • 任务记录 │
    └─────────┘                         └─────────┘
```

## 核心组件

### 1. API Server (apiserver/)

**职责**：
- 定时任务管理（CronJob）
- 任务调度和分发
- 执行状态跟踪
- WebSocket服务提供
- 分布式锁管理

**核心模块**：
- `pkg/core/`: 核心数据模型和接口定义
- `pkg/controllers/`: HTTP API控制器
- `pkg/services/`: 业务逻辑服务
- `pkg/store/`: 数据访问层
- `pkg/app/`: 应用启动和配置

**关键实体**：
- `CronJob`: 定时任务定义
- `Task`: 任务执行记录
- `Worker`: 工作节点信息

### 2. Worker (worker/)

**职责**：
- 接收任务执行指令
- 根据任务类型选择合适的Runner
- 执行具体任务
- 实时上报执行状态和结果
- 心跳保活

**核心模块**：
- `pkg/core/`: 核心数据模型和接口
- `pkg/services/`: 业务服务实现
- `pkg/runner/`: 任务执行器实现
- `pkg/app/`: 应用启动和配置

**关键服务**：
- `WebsocketService`: WebSocket通信服务
- `TaskService`: 任务处理服务
- `Runner`: 任务执行器接口

## 数据流

### 1. 任务创建流程
```
用户创建CronJob → API Server存储 → 调度服务计算下次执行时间
```

### 2. 任务执行流程
```
调度服务触发 → 创建Task → 选择Worker → WebSocket分发 → Worker执行 → 结果上报
```

### 3. 状态同步流程
```
Worker执行任务 → 实时状态更新 → WebSocket上报 → API Server更新Task状态
```

## 通信协议

### WebSocket消息格式

**服务端到客户端（任务事件）**：
```json
{
  "action": "run|stop|kill|timeout|retry",
  "tasks": [
    {
      "id": "task-uuid",
      "command": "ls",
      "args": "{\"path\": \"/tmp\"}",
      "timeout": 30
    }
  ]
}
```

**客户端到服务端（状态更新）**：
```json
{
  "action": "task_update",
  "worker_id": "worker-uuid",
  "task_id": "task-uuid",
  "data": {
    "status": "running|success|failed|timeout",
    "output": "执行结果",
    "time_start": "2024-01-01T10:00:00Z",
    "time_end": "2024-01-01T10:00:30Z"
  }
}
```

## 任务分类系统

系统通过`Task.Category`字段来区分不同类型的任务，每种类型对应一个特定的Runner：

- `command`: 系统命令执行（CommandRunner）
- `script`: 脚本执行（ScriptRunner）
- `docker`: Docker容器执行（DockerRunner）
- `http`: HTTP请求执行（HttpRunner）

## 分布式特性

### 1. 分布式锁
- 基于Redis实现
- 确保同一任务不会在多个Worker上重复执行
- 支持锁超时和自动释放

### 2. 任务调度
- 支持cron表达式
- 自动计算下次执行时间
- 支持任务链和任务组

### 3. 高可用
- Worker节点自动注册和心跳
- 支持多Worker负载均衡
- 任务失败自动重试

## 配置管理

### API Server配置
- 数据库连接配置
- Redis连接配置
- WebSocket服务配置
- 日志配置

### Worker配置
- API Server连接配置
- Worker节点信息
- Runner配置
- 心跳间隔配置

## 监控和日志

### 1. 任务监控
- 实时任务状态跟踪
- 执行时间统计
- 成功率监控

### 2. 系统监控
- Worker节点状态
- 系统资源使用情况
- 错误日志收集

### 3. 日志系统
- 结构化日志（JSON格式）
- 分级日志记录
- 日志轮转和归档

## 扩展性设计

### 1. Runner扩展
- 插件化Runner架构
- 支持自定义Runner实现
- 动态Runner注册

### 2. 存储扩展
- 支持多种数据库
- 可配置存储后端
- 数据迁移支持

### 3. 通信扩展
- 支持多种通信协议
- 可配置消息格式
- 支持消息队列集成

## 安全考虑

### 1. 认证授权
- API Token认证
- Worker节点认证
- 权限控制

### 2. 数据安全
- 敏感信息加密
- 传输加密（WSS）
- 数据备份和恢复

### 3. 执行安全
- 命令白名单
- 资源限制
- 沙箱执行环境

## 部署架构

### 开发环境
```
API Server (单实例) + Worker (单实例) + Redis (单实例) + MySQL (单实例)
```

### 生产环境
```
API Server (多实例) + Worker (多实例) + Redis (集群) + MySQL (主从)
```

### 容器化部署
- Docker镜像构建
- Kubernetes部署
- 服务发现和负载均衡
